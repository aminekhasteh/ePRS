---
title: "HMG Revision"
output: html_document
date: "2023-04-23"
---

# Libraries

```{r setup, include=FALSE}
library(tidyverse)
library(rmarkdown)
library(reshape2)
library(ggplot2)
library(forcats)
```

# Functions

```{r}
# this function generates the pairwise correlation matrix of selected PRSs
mat_creator<-function(lmatrix,prs_of_interest){
  prs_lst <- list()
  for(p_val in names(lmatrix)){
  if(sum(prs_of_interest %in% names(lmatrix[[p_val]]$residuals))==length(prs_of_interest)){
    prs <- lmatrix[[p_val]]$residuals[prs_of_interest]
    cormat <- round(cor(prs),2)
    # Reorder the correlation matrix
    cormat <- reorder_cormat(cormat)
    upper_tri <- get_upper_tri(cormat)
    # Melt the correlation matrix
    melted_cormat <- reshape2::melt(upper_tri, na.rm = TRUE)
    prs_lst[[p_val]] <- melted_cormat
  }
  }
  # binding the list into one dataframe:
  mat <- bind_rows(prs_lst,.id = "alpha-value")
  return(mat)
}

## These functions help set up our data for heatmaps:
# Get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
                cormat[upper.tri(cormat)] <- NA
                return(cormat)
}
# Get upper triangle of the correlation matrix
get_upper_tri <- function(cormat){
                cormat[lower.tri(cormat)]<- NA
                return(cormat)
}
# reorder the correlations
reorder_cormat <- function(cormat){
                # Use correlation between variables as distance
                dd <- as.dist((1-cormat)/2)
                hc <- hclust(dd)
                cormat <-cormat[hc$order, hc$order]
}

# This function sets up the heatmap in ggplot:
heatmap_plotter<- function(mat,ncol=5){
  # Create a ggheatmap
  p <- ggplot(mat, aes(Var2, 
                       Var1, 
                       fill = value))+
                  geom_tile(color = "white")+
                  facet_wrap(~`alpha-value`,ncol=ncol) +
                  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                                       name="Pearson\nCorrelation") +
                  theme_minimal()+ # minimal theme
                  theme(axis.text.x = element_text(angle = 90, vjust = 1, 
                                                   hjust = 1),
                        plot.title = element_text(hjust = 0.5))+
                  coord_fixed() + 
                  theme(
                                  axis.title.x = element_blank(),
                                  axis.title.y = element_blank(),
                                  panel.grid.major = element_blank(),
                                  panel.border = element_blank(),
                                  panel.background = element_blank(),
                                  axis.ticks = element_blank(),
                                  legend.justification = c(1, 0),
                                  legend.position = c(0.6, 0.7),
                                  legend.direction = "horizontal")+
                  guides(fill = "none") +
                  ggtitle("") +
                  geom_text(aes(Var2, Var1, label = value), 
                            color = "black", size = 2.5)
  return(p)
}
```

```{r}
path <- "../Datasets/CLUMP_500_0.2/ROSMAP/Resid_PRS/With_MHC_APOE/"
# read in residuals of PRSs files
lmatrix <- readRDS(paste0(path,"/Residual_results_all_p-vals.rds"))
```

# Major concern by first reviewer:

-   The phenotypes used in the authors' analysis seemed to contain some redundant hierarchical classifications (e.g., Sicca syndrome \<- diffuse diseases of connective tissue; rosuvastatin \<- HMG-CoA reductase inhibitor statins). These trait redundancies may significantly bias the PRSs clustering results.

```{r}
# First, checking for:
  ## CA_PR_rosuvastatin_h0.06480
  ## PR_rosuvastatin_h0.07368
  ## PR_HMG_CoA_reductase_inhibitor_statin_h0.05834
prs_of_interest <- c("CA_PR_rosuvastatin_h0.06480",
                     "PR_HMG_CoA_reductase_inhibitor_statin_h0.05834")
mat <- mat_creator(lmatrix,prs_of_interest)
```

```{r fig.height=10, fig.width=10}
# Create a ggheatmap
p <- heatmap_plotter(mat,5)
print(p)
```

```{r}
# Second, checking for:
  ## PH_Sicca_syndrome_h0.22589
  ## PH_Diffuse_diseases_of_connective_tissue_h0.06227
prs_of_interest <- c("PH_Sicca_syndrome_h0.22589",
                     "PH_Diffuse_diseases_of_connective_tissue_h0.06227")
mat <- mat_creator(lmatrix,prs_of_interest)
```

```{r fig.height=10, fig.width=10}
# Create a ggheatmap
p <- heatmap_plotter(mat,4)
print(p)
```

Now, checking for other duplicated phenotypes that could potentially cause some bias and were not excluded in the initital QC of the phenotype selection.

```{r}
# Third, checking for:
  ## CA_PR_detrusitol_1mg_tablet_h0.24664
  ## CA_PR_vesicare_5mg_tablet_h0.08801
  ## CA_PR_oxybutynin_h0.09803
  ## CA_PR_solifenacin_h0.12966
# these are prescriptions that are all presecribed to Urinary incontinence with different branded names.
prs_of_interest <- c("CA_PR_detrusitol_1mg_tablet_h0.24664",
                     "CA_PR_vesicare_5mg_tablet_h0.08801",
                     "CA_PR_oxybutynin_h0.09803",
                     "CA_PR_solifenacin_h0.12966")
mat <- mat_creator(lmatrix,prs_of_interest)
```

```{r fig.height=10, fig.width=10}
p <- heatmap_plotter(mat,4)
print(p)
```
